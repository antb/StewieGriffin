###
# Copyright (c) 2011, Anthony Boot
# All rights reserved.
#
#
###

import supybot.utils as utils
from supybot.commands import *
import supybot.plugins as plugins
import supybot.ircutils as ircutils
import supybot.callbacks as callbacks
import supybot.ircmsgs as ircmsgs
import supybot.schedule as schedule
import random,time,json


class CustOps(callbacks.Plugin):
	"""Custom op commands."""
	threaded = True

	random.seed()
	for each in range(0,random.randint(50,100)): i = random.random()
        del i

	def stab(self,irc,msg,args,channel,user):
		"""stab \x02<user>\x07

		Stabs a user, putting them on quiet for a random time up to 10 mins."""

		irc.queueMsg(ircmsgs.IrcMsg('MODE {0} +q {1}'.format(channel,user)))

		t = time.time()
		r = random.randint(30,300)
		expires = t+r

		len={}
		len['m'] = 0
		len['s'] = 0
		while r > 59:
			len['m']+=1
			r-=60
		len['s'] = r	

		irc.queueMsg(ircmsgs.IrcMsg('NOTICE {0} :{1} has been quieted for {2}:{3}'.format(msg.nick,user,len['m'],len['s'])))

		def f():
			irc.queueMsg(ircmsgs.IrcMsg('MODE {0} -q {1}'.format(channel,user)))

		schedule.addEvent(f,expires)

		 
		irc.noReply()
	stab = wrap(stab,['op',('haveOp','Quiet a user'),'nickInChannel'])

	def setinfo(self,irc,msg,args,channel,user,infoline):
		"""\x02<user> <infoline>\x02

		Allows an op to set an info line about a user."""
		if msg.nick.lower() is user.lower(): irc.error('Nice try')
		try: self.infoLines
		except: self._getInfo()

		try:	self.infoLines[user.lower()]
		except:	self.infoLines[user.lower()]={}

		self.infoLines[user.lower()][msg.nick.lower()]=infoline
		with open('INFOLINES','w') as f:
				f.write(json.dumps(self.infoLines,sort_keys=True,indent=4))
		irc.replySuccess('| Infoline added')
	setinfo = wrap(setinfo, ['op',('haveOp','Set info lines'),	'nick',	'text'])

	def _getInfo(self):
#		try:
			with open('INFOLINES','r') as f:
				self.infoLines=json.load(f)
#		except:
#			self.infoLines={}
#			with open('INFOLINES','w') as f:
#				json.dump(self.infoLines,f)

	def reinfo(self,irc,msg,args,channel):
		self._getInfo()
	reinfo = wrap(reinfo,['owner'])

	def info(self,irc,msg,args,user,op):
		"""\x02<user>\x02

		Shows an operator set infoline about a user"""
		try: self.infoLines
		except: self._getInfo()

		if not user: user = msg.nick

		try: i = self.infoLines[user.lower()]
		except: irc.error('User not found in DB')

		if not op:
			op = random.choice(list(self.infoLines[user.lower()]))
		op=op.lower()
		if 'all' in op:
			msg = ''
			for each in self.infoLines[user.lower()]:
				msg+='{0}:{1} | '.format(each,self.infoLines[user.lower()][each])
			irc.reply(msg,prefixNick=False
			return 0

		try: irc.reply('{0} by {1} -> {2}'.format(user, op, self.infoLines[user.lower()][op]), prefixNick=False)
		except: irc.error('{0} hasn\'t provided an infoline for {1} or isn\'t an op'.format(op,user))
	info = wrap(info,[optional('nick'),optional('nick')])

		
		
Class = CustOps


# vim:set shiftwidth=4 softtabstop=4 expandtab textwidth=79:
