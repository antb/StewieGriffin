###
# Copyright (c) 2011, Anthony Boot
# All rights reserved.
#
# Licenced under GPLv2
# In brief, you may edit and distribute this as you want, provided the original
# and modified sources are always available, this license notice is retained
# and the original author is given full credit.
#
# There is no warrenty or guarentee, even if explicitly stated, that this
# script is bug and malware free. It is your responsibility to check this
# script and ensure its safety.
#
###

import supybot.utils as utils
from supybot.commands import *
import supybot.plugins as plugins
import supybot.ircutils as ircutils
import supybot.callbacks as callbacks

import re
import supybot.ircmsgs as ircmsgs
import random as random

class General(callbacks.PluginRegexp):
    """Some general purpose plugins."""
    threaded=True
    regexps=['greeter','awayMsgKicker','ytSnarfer']

    #Set to false to disable.
    consolechannel = "##sgoutput"

#####################
###   Commands    ###
#####################
    def banmask(self, irc, msg, args, hostmask):
        """<nick|hostmask>

        Gets IP based hostmask for ban. """
        failed = False
        ipre = re.compile(r"[0-9]{1,3}[.-][0-9]{1,3}[.-][0-9]{1,3}[.-][0-9]")
        bm = ipre.search(hostmask)
        try:        
            bm = bm.group(0)
            bm = bm.replace(".","?")
            bm = bm.replace("-","?")
            irc.reply("*!*@*"+bm+"*")
            if(self.consolechannel): irc.queueMsg(ircmsgs.privmsg(self.consolechannel, "BANMASK: *!*@*"+bm+"* returned for "+msg.nick))
        except:
            hostmask = hostmask.split("@")[1]
            count=0;
            while count<10:
                hostmask = hostmask.replace(str(count),"?")
                count+=1
            irc.reply("*!*@%s"%(hostmask),prefixNick=False)
            if(self.consolechannel): irc.queueMsg(ircmsgs.privmsg(self.consolechannel, "BANMASK: *!*@%s returned for %s"%(hostmask,msg.nick)))
    banmask = wrap(banmask, ["hostmask"])

    def rand(self,irc,msg,args,cap,num):
        """<max> [amount]

        Generates a random number up to <max>, [amount] number of times."""
        random.seed()
        random.seed(random.random())
        if not num:
            num = 1
        try:
            cap = int(cap)+1
            num = int(num)
        except:
            irc.error("Non numeric value(s) given")
        if num > 25:
            num = 25
        x = 0;
        output = ""
        while x < num:
            output+=str(int(random.random()*cap))+" "
            x+=1
        irc.reply(output)

    rand = wrap(rand,['something',optional('something')])

    def stewieQuote(self, irc, msg, args):
        data = utils.web.getUrl("http://smacie.com/randomizer/family_guy/stewie_griffin.html")
        quote = data.split('<td valign="top"><big><big><big><font face="Comic Sans MS">')[1].split('</font></big></big></big></td>')[0]
        irc.reply(quote,prefixNick=False)
    stewie = wrap(stewieQuote)

    def geoip(self,irc,msg,args,ohostmask):
        ohostmask = ohostmask.split('@')[1]
        if msg.nick.lower() in ohostmask:
            irc.reply('Unable to locate IP - User cloak detected'%ohostmask)
            return None

        ipre = re.compile(r"[0-9]{1,3}[.-][0-9]{1,3}[.-][0-9]{1,3}[.-][0-9]")
        hostmask = ipre.search(ohostmask)
	if hostmask:
            try:        
                hostmask = hostmask.group(0)
                hostmask = hostmask.replace("-",".")
            except:
                hostmask = hostmask
        else:
            hostmask = ohostmask 

        self.log.info("GeoIP: %s",hostmask)
#        if 'gateway' in hostmask:
 #           hostmask = hostmask.split('ip.')[1]

        data = utils.web.getUrl('http://infosniper.net/?ip_address=%s'%hostmask)
        data = data.split('<!-- ################################################################################## -->')[5]
        data = re.split('<[^<>]+>|\\n|&nbsp;|    |   |  ',data)

        x = 0
        info = []
        while x < len(data):
            if data[x] is '' or (len(data[x])<2 and ' ' in data[x]) :
                pass
            else:
                info+=[data[x]]
            x+=1

        country = info[20]
        city = info[5]
        tz = info[27]
        to = info[30]
        if '-' not in to:
            to = '+%s'%to
        lat = info[13]
        lon = info[21]
        provider = info[11]

        if 'EUKHOST LTD' in provider:
            irc.reply("Unable to locate IP - Not found")
            return None

        tinyurl=utils.web.getUrl('http://tinyurl.com/api-create.php?url=http://maps.google.com/maps?q=%s,%s'%(lat,lon))

        irc.reply('%s is near %s in %s (%s). The timezone is %s and is UTC/GMT%s. The provider is %s'%(hostmask,city,country,tinyurl,tz,to,provider))
        return None
    geoip = wrap(geoip, ['hostmask'])

#####################
###    RegExps    ###
#####################
    def greeter(self, irc, msg, match):
        r"^(hello|hi|sup|hey|o?[bh]ai|wa+[sz]+(a+|u+)p?|Bye*|cya*|later[sz]?)[,. ]+(stewi?e?[griffin]?|bot|all|there)"
        if "," in match.group(0):
            hail = match.group(0).split(",")[0]
        elif "." in match.group(0):
            hail = match.group(0).split(".")[0]
        else:
            hail = match.group(0).split(" ")[0]
        self.log.info("Responding to %s with %s"%(msg.nick, hail))
        if(self.consolechannel): irc.queueMsg(ircmsgs.privmsg(self.consolechannel, "GREETER: Responding to %s with %s"%(msg.nick,hail)))
        irc.reply("%s, %s"%(hail.capitalize(),msg.nick), prefixNick=False)
    greeter = urlSnarfer(greeter)

    def awayMsgKicker(self, irc, msg, match):
        r"(is now away - Reason :|is no longer away : Gone for|is away:)"
        self.log.info("KICKING %s for away announce"%msg.nick)
        if(self.consolechannel):irc.queueMsg(ircmsgs.privmsg(self.consolechannel, "KICK: %s for away announcement (automatic)"%msg.nick))
        self._sendMsg(irc, ircmsgs.kick(msg.args[0], msg.nick, "Autokick: Spam (Away/Back Announce)"))
    awayMsgKicker = urlSnarfer(awayMsgKicker)

    def ytSnarfer(self, irc, msg, match):
        r".+youtube[.]com.+v=[0-9A-z\-_]{11}.*"
        self.log.info("ytSnarfer - Active")
        url = match.group(0)
        url = url.split(" ")

        for x in url:
            if "youtu" in x:
                url = url[url.index(x)]

        if url.find("v=") != -1 or url.find("&") != -1:
            if url.find("v=") != -1:
                url = url.split("v=")[1]
            if url.find("&") != -1:
               url = url.split("&")[0]
        else:
            url = url[-11:]
        
        self.log.info("ytSnarfer - Video ID: %s"%(url))

        url="http://www.youtube.com/watch?v="+url

        data = utils.web.getUrl(url)
	data = data.split("&#x202a;")[1].split("&#x202c;")[0]
#        data = data.split("<title>")[1]
#        data = data.split("</title>")[0]

        data = data.replace("&quot;","\'").replace("&#39;", "'").replace("&amp;","&")	

        irc.reply('Youtube video is "%s"'%data, prefixNick=False)
        self.log.info("ytSnarfer - Done.")
        if(self.consolechannel):irc.queueMsg(ircmsgs.privmsg(self.consolechannel, "%s is %s"%(url,data)))
        return None
    ytSnarfer = urlSnarfer(ytSnarfer)

#####################
###   Utilities   ###
#####################
    def _sendMsg(self, irc, msg):
        irc.queueMsg(msg)
        irc.noReply()

Class = General


# vim:set shiftwidth=4 softtabstop=4 expandtab textwidth=79:
